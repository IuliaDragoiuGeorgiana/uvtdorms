<div class="dorm-machines-page-body">
  <div class="card">
    <p-table
      [value]="isWashingMachineLabelingSelected() ? washingMachines : isDryerLabelingSelected() ? dryers : []"
      dataKey="name"
      [tableStyle]="{ 'min-width': '60rem' }">
      <ng-template pTemplate="caption">
        <div
          class="washing-machines-table-caption">
          <div class="listed-machines-type-select-container">
            <p-dropdown
              [options]="listableMachineTypes"
              [(ngModel)]="listedMachinesType"
              optionLabel="name"
              optionValue="type"
            >
            </p-dropdown>
          </div>
          <p-button icon="pi pi-plus" (click)="openNew()" severity="success"></p-button>
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5rem"></th>
          <th pSortableColumn="name">
            Name <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th>
            {{isDryerLabelingSelected() ? 'Associated Washing Machine' : ''}}
            {{isWashingMachineLabelingSelected() ? 'Associated Dryer' : ''}}
          </th>
          <th>Status</th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-product let-expanded="expanded">
        <tr>
          <td>
            <button
              type="button"
              pButton
              pRipple
              [pRowToggler]="product"
              class="p-button-text p-button-rounded p-button-plain"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
          </td>
          <td>{{ product.name }}</td>
          <td>
            {{ isWashingMachineLabelingSelected() ? getAssociatedDryerName(product) : ''}}
            {{ isDryerLabelingSelected() ? getAssociatedWashingMachineName(product) : ''}}
          </td>
          <td>
            <p-tag
              [value]="getStatus(product)"
              [severity]="getStatusSeverity(product)"></p-tag>
          </td>
          <td>
            <button
              type="button"
              pButton
              pRipple
              icon="pi pi-pencil"
              (click)="editMachine(product)"
              severity="info"
            >
            </button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="rowexpansion" let-product>
        <tr>
          <td colspan="7">
            <div class="p-3">
              <p-table
                [value]="getWeeklyAppointments(product)"
                dataKey="intervalBeginDate">
                <ng-template pTemplate="header">
                  <tr>
                    <th pSortableColumn="intervalBeginDate">
                      Hour <p-sortIcon field="intervalBeginDate"></p-sortIcon>
                    </th>
                    <th pSortableColumn="studentEmail">
                      Student <p-sortIcon field="studentEmail"></p-sortIcon>
                    </th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-order>
                  <tr>
                    <td>{{ formatDate(order.intervalBeginDate) }}</td>
                    <td>{{ order.studentEmail }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="6">
                      There are no appointments for this machine yet.
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  <p-dialog
    [(visible)]="addSomething"
    [style]="{ width: '60vw' }"
    header="Machine Details"
    [modal]="true"
    styleClass="p-fluid">
    <p-stepper [linear]="true">
      <p-stepperPanel header="Select machine type">
        <ng-template
          pTemplate="content"
          let-nextCallback="nextCallback"
          let-index="index">
          <div class="select-machine-type-header">
            <h1 class="select-machine-type-header-h">
              What type of machine do you want to add?
            </h1>
          </div>
          <div class="select-machine-type-buttons">
            <div class="select-machine-type-buttons-left">
              <p-button
                class="select-machine-type-button"
                label="Washing machine"
                severity="info"
                [raised]="true"
                (onClick)="
                  nextCallback.emit();
                  selectMachine(machineType.WASHING_MACHINE)
                "></p-button>
            </div>
            <div class="select-machine-type-buttons-right">
              <p-button
                class="select-machine-type-button"
                label="Dryer"
                severity="info"
                [raised]="true"
                (onClick)="
                  nextCallback.emit(); selectMachine(machineType.DRYER)
                "></p-button>
            </div></div></ng-template>
      </p-stepperPanel>

      <p-stepperPanel header="Set machine details">
        <ng-template
          pTemplate="content"
          let-prevCallback="prevCallback"
          let-nextCallback="nextCallback"
          let-index="index">
          <div class="set-machine-details-body">
            <form 
              [formGroup]="newMachineForm"
              class="set-machine-details-body-form">
              <p-floatLabel class="set-machine-details-body-form-item">
                <input
                  pInputText
                  formControlName="name"
                  type="text"
                  id="machine-name"
                  [ngClass]="{'ng-invalid ng-dirty': newMachineForm.get('name')?.invalid && newMachineForm.get('name')?.touched}"
                  />
                <label for="machine-name">
                  {{isDryerSelected() ? 'Dryer name' :''}}
                  {{isWashingMachineSelected() ? 'Washing Machine name' :''}}
                </label>
              </p-floatLabel>

              <p-dropdown
                [options]="getAvailableMachines()"
                formControlName="associatedDryerOrWashingMachineId"
                optionLabel="name"
                optionValue="id"
                placeholder="Select a Dryer"
                class="set-machine-details-body-form-item"
                emptyMessage="There are no available machines">
              </p-dropdown>
            </form>
          </div>

          <div class="set-machine-details-buttons-form">
            <div class="set-machine-details-buttons-form-left">
              <p-button
                label="Back"
                icon="pi pi-arrow-left"
                severity="warning"
                [raised]="true"
                class="set-machine-details-buttons-form-button"
                (onClick)="prevCallback.emit(); newMachineForm.reset()" />
            </div>

            <div class="set-machine-details-buttons-form-right">
              <p-button
                label="Next"
                icon="pi pi-arrow-right"
                iconPos="right"
                [raised]="true"
                severity="success"
                class="set-machine-details-buttons-form-button"
                (onClick)="newMachineForm.valid ? nextCallback.emit() : newMachineForm.controls['name'].markAsTouched()" />
            </div>
          </div>
        </ng-template>
      </p-stepperPanel>

      <p-stepperPanel header="Confirm">
        <ng-template
          pTemplate="content"
          let-prevCallback="prevCallback"
          let-index="index">

          <div class="set-machine-confirm-body-header">
            <h1>Are you sure you want to add the following machine?</h1>
          </div>

          <div class="set-machine-confirm-body">
            <div class="set-machine-confirm-body-left">
              <p>Machine type:</p>
              <p>Machine name:</p>
              <p>Associated machine:</p>
            </div>
            <div class="set-machine-confirm-body-right">
              <p>{{isDryerSelected() ? 'Dryer' : 'Washing machine'}}</p>
              <p>{{newMachineForm.get('name')?.value}}</p>
              <p>{{getAssociatedMachineName()}}</p>
            </div>
          </div>

          <div class="set-machine-confirm-buttons">
            <div class="set-machine-confirm-buttons-left">
              <p-button
                label="Back"
                icon="pi pi-arrow-left"
                [raised]="true"
                severity="warning"
                class="set-machine-confirm-buttons-button"
                (onClick)="prevCallback.emit();" />
            </div>

            <div class="set-machine-confirm-buttons-right">
              <p-button
                label="Confirm"
                icon="pi pi-arrow-right"
                iconPos="right"
                [raised]="true"
                severity="success"
                class="set-machine-confirm-buttons-button"
                (onClick)="submitNewMachineForm()" />
            </div>
          </div>
        </ng-template>
      </p-stepperPanel>

    </p-stepper>
  </p-dialog>
  <p-dialog 
    [header]="isWashingMachineLabelingSelected() ? 'Edit Washing machine' :
              isDryerLabelingSelected() ? 'Edit Dryer' : ''"
    [modal]="true"
    [(visible)]="isEditDialogVisible"
    [style]="{ width: '25rem' }">
    <div class="edit-machine-body">
      <div class="edit-machine-name edit-machine-item-container">
          <label for="name" class="edit-machine-name-label">
            {{isWashingMachineLabelingSelected() ? 'Washing Machine Name' : ''}}
            {{isDryerLabelingSelected() ? 'Dryer Name' : ''}}
          </label>
          <input pInputText [(ngModel)]="newMachineName" id="name" class="edit-machine-name-input edit-machine-item" autocomplete="off" />
      </div>

      <div class="edit-associated-machine edit-machine-item-container">
        <label for="associated-machine" class="edit-associated-machine-label">
          {{isWashingMachineLabelingSelected() ? 'Associated Dryer' : ''}}
          {{isDryerLabelingSelected() ? 'Associated Washing Machine' : ''}}
        </label>
        <p-dropdown
          [options]="getAvailableMachinesForEditing()"
          [(ngModel)]="newAssociatedMachine"
          optionLabel="name"
          optionValue="id"
          class="edit-machine-item"
          [placeholder]="
            isDryerLabelingSelected() ? 'Select Associated Washing Machine' :
            isWashingMachineLabelingSelected() ? 'Select Associated Dryer' : ''
          "
          emptyMessage="There are no available machines"
          id="associated-machine">
        </p-dropdown>
      </div>

      <div class="edit-machine-status edit-machine-item-container">
        <label for="machine-status" class="edit-machine-status-label">
          {{isWashingMachineLabelingSelected() ? 'Washing Machine Status' : ''}}
          {{isDryerLabelingSelected() ? 'Dryer Status' : ''}}
        </label>
        <p-dropdown
          [options]="machineStatusOptions"
          [(ngModel)]="newMachineStatus"
          optionLabel="label"
          optionValue="value"
          class="edit-machine-item"
        >
        </p-dropdown>
      </div>
    </div>
    <div class="edit-machine-buttons">
        <p-button label="Cancel" severity="secondary" (click)="isEditDialogVisible = false" />
        <p-button label="Save" (click)="saveMachine()" />
    </div>
</p-dialog>
</div>
